!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.e?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(1);t.t=function(){return"undefined"!=typeof window&&window.t?window.t:"undefined"!=typeof global&&global.t?global.t:r.t}(),t.r=function(e){return e?JSON.parse(JSON.stringify(e)):null};var i=function(){function e(e){this.callbacks=e}return e.prototype.then=function(e){var n=this,r=[],i=0;this.callbacks&&this.callbacks.length||e([]);var o=function(){i<n.callbacks.length?n.callbacks[i](function(e){r.push(e),i++,t.t.resolve().then(o)}):e(r)};o()},e}();t.CHAIN=i;var o=function(){function e(e){this.callbacks=e}return e.prototype.then=function(e){var t=this,n=[],r=0;this.callbacks&&this.callbacks.length||e([]),this.callbacks.forEach(function(i,o){i(function(i){n[o]=i,++r===t.callbacks.length&&e(n)})})},e}();t.ALL=o,t.fastCHAIN=function(e,n){return new t.t(function(t,i){if(!e||!e.length)return void t([]);var o=[],s=function(){o.length<e.length?n(e[o.length],o.length,function(e){o.push(e),o.length<100?s():r.setFast(s)}):t(o)};s()})},t.fastALL=function(e,n){return new t.t(function(t,r){if(!e||!e.length)return void t([]);for(var i=e.length,o=[];i--;)n(e[i],i,function(n){o.push(n),o.length===e.length&&t(o)})})};var s="undefined"==typeof window?"":navigator.userAgent;t.isSafari=0!==s.length&&(/^((?!chrome|android).)*safari/i.test(s)||/iPad|iPhone|iPod/.test(s)&&!window.MSStream),t.isMSBrowser=0!==s.length&&(s.indexOf("MSIE ")>0||s.indexOf("Trident/")>0||s.indexOf("Edge/")>0),t.isAndroid=/Android/.test(s),t.random16Bits=function(){if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){var e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!==global&&global.a.randomBytes?global.a.randomBytes(2).reduce(function(e,t){return t*e}):Math.round(Math.random()*Math.pow(2,16))},t.timeid=function(e){for(var n=Math.round((new Date).getTime()/(e?1:1e3)).toString();n.length<(e?13:10);)n="0"+n;return n+"-"+(t.random16Bits()+t.random16Bits()).toString(16)},t.uuid=function(){var e,n,r="";return[r,r,r,r,r,r,r,r,r].reduce(function(i,o,s){for(e=t.random16Bits(),n=4===s?s:5===s?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+([3,4,5,6].indexOf(s)>-1?"-":r)+(n+e).slice(0,4)},r)},t.hash=function(e){for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString(16)};var a={int:function(e){return e},uuid:t.uuid,timeId:function(){return t.timeid()},timeIdms:function(){return t.timeid(!0)}};t.generateID=function(e,t){return a[e]?a[e](t||1):""},t.cleanArgs=function(e,n){for(var r={},i=e.length;i--;){var o=e[i].split(":");o.length>1?r[o[0]]=t.cast(o[1],n[o[0]]||void 0):r[o[0]]=n[o[0]]||void 0}return r},t.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.cast=function(e,n){if("any"===e||"blob"===e)return n;var r=typeof n;if("undefined"===r||null===n)return n;var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},o=function(e,n){switch(e){case"safestr":return o("string",n).replace(/[&<>"'`=\/]/gim,function(e){return i[e]});case"int":return"number"!==r||n%1!=0?parseInt(n||0):n;case"number":case"float":return"number"!==r?parseFloat(n||0):n;case"any[]":case"array":return Array.isArray(n)?n:[];case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==r?String(n):n;case"object":case"obj":case"map":return t.isObject(n)?n:{};case"boolean":case"bool":return!0===n}return n},s=o(String(e||"").toLowerCase(),n);if(-1!==e.indexOf("[]")){var a=e.slice(0,e.lastIndexOf("[]"));return(n||[]).map(function(e){return t.cast(a,e)})}return void 0!==s?["int","float","number"].indexOf(e)>-1&&isNaN(s)?0:s:void 0},t.sortedInsert=function(e,n,r,i){return e.length?(e.splice(t.binarySearch(e,n),0,n),e):(e.push(n),e)},t.binarySearch=function(e,n,r,i){var o=e.length,s=r||0,a=void 0!==i?i:o-1;if(0===o)return 0;if(n>e[a])return a+1;if(n<e[s])return s;if(s>=a)return 0;var u=s+Math.floor((a-s)/2);return n<e[u]?t.binarySearch(e,n,s,u-1):n>e[u]?t.binarySearch(e,n,u+1,a):0},t.removeDuplicates=function(e){if(!e.length)return[];for(var t=[e[0]],n=1;n<e.length;n++)e[n]!==e[n-1]&&t.push(e[n]);return t},t.deepFreeze=function(e){return Object.getOwnPropertyNames(e||{}).forEach(function(n){var r=e[n];"object"==typeof r&&null!==r&&(e[n]=t.deepFreeze(r))}),Object.freeze(e)};var u={};t.objQuery=function(e,t,n){var r=function(e,t,n){return e[t]&&n?r(e,t+1,n[e[t]]):n},i=e+(n?"1":"0"),o=u[i]||[];if(o.length)return r(o,0,t);if(o=e.indexOf("[")>-1?[].concat.apply([],e.split(".").map(function(e){return e.match(/([^\[]+)|\[([^\]]+)\]\[/gim)||e})).map(function(e){return e.replace(/\[|\]/gim,"")}):e.split("."),n){var s=o.shift()+"."+o.shift();o.unshift(s)}return u[i]=o,r(o,0,t)}},function(e,t,n){"use strict";function r(e,n,r){t.setFast(function(){var t;try{t=n.apply(null,r)}catch(t){return x.u(e,t)}return t===e?x.u(e,new TypeError):x.f(e,t),null})}function i(e){var t=e&&e.then;return!e||"object"!=typeof e&&"function"!=typeof e||"function"!=typeof t?null:function(){t.apply(e,arguments)}}function o(e,t){function n(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];o||(o=!0,x.u(e,t))}function r(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];o||(o=!0,x.f(e,t))}function i(){t(r,n)}var o=!1,a=s(i);"error"===a.h&&n(a._)}function s(e,t){var n={h:null,_:null};try{n._=e(t),n.h="success"}catch(e){n.h="error",n._=e}return n}Object.defineProperty(t,"__esModule",{value:!0});var a=0,u={},c=Array.prototype.slice,f="undefined"!=typeof window&&window.setImmediate?window.setImmediate:!("undefined"==typeof global||!global.setImmediate)&&global.setImmediate,h="undefined"!=typeof window&&window.postMessage&&window.addEventListener,l="undefined"!=typeof window&&window.t?window.t:!("undefined"==typeof global||!global.t)&&global.t,_=function(e){return e[0].apply(null,c.call(e,1))},d=function(e){var t,n=e.data;"string"==typeof n&&0===n.indexOf("setMsg")&&(t=u[n])&&(delete u[n],_(t))};"undefined"!=typeof window&&window.addEventListener("message",d);var p=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=a++,r="setMsg"+n;return u[r]=e,window.postMessage(r,"*"),n};t.setFast=function(){return f?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];f(function(){_(e)})}:l?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];l.resolve().then(function(){_(e)})}:h?p:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];setTimeout(function(){_(e)},0)}}();var y=function(){},b=["R"],v=["F"],g=["P"],m=function(){function e(e){this.y=g,this.b=[],this.v=void 0,e!==y&&o(this,e)}return e.doPolyFill=function(){"undefined"!=typeof global&&(global.t||(global.t=this)),"undefined"!=typeof window&&(window.t||(window.t=this))},e.prototype.catch=function(e){return this.then(function(){},e)},e.prototype.then=function(t,n){if("function"!=typeof t&&this.y===v||"function"!=typeof n&&this.y===b)return this;var i=new e(y);return this.y!==g?r(i,this.y===v?t:n,this.v):this.b.push(new w(i,t,n)),i},e.resolve=function(t){return t instanceof this?t:x.f(new e(y),t)},e.reject=function(t){return x.u(new e(y),t)},e.all=function(t){return new e(function(e,n){var r=[];if(!t.length)return void e([]);for(var i=function(n,i,o){void 0!==o?r.push(o):r.push(i),r.length==t.length&&e(r)},o=0;o<t.length;o++)!function(e){t[e].then(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i(0,e,void 0)}).catch(function(e){i(0,void 0,e)})}(o)})},e.race=function(t){var n=this,r=t.length,i=!1,o=-1,s=new e(y);if(!1!==Array.isArray(t))return this.reject(new TypeError);if(!r)return this.resolve([]);for(;++o<r;)!function(e){n.resolve(e).then(function(e){i||(i=!0,x.f(s,e))},function(e){i||(i=!0,x.u(s,e))})}(t[o]);return s},e}();t.t=m;var w=function(){function e(e,t,n){this.g=e,"function"==typeof t&&(this.w=t,this.x=this.O),"function"==typeof n&&(this.k=n,this.I=this.A)}return e.prototype.x=function(e){x.f(this.g,e)},e.prototype.O=function(e){r(this.g,this.w,e)},e.prototype.I=function(e){x.u(this.g,e)},e.prototype.A=function(e){r(this.g,this.k,e)},e}();t.S=w;var x=function(){function e(){}return e.f=function(t,n){var r=s(i,n),a=r._,u=-1,c=t.b.length;if("error"===r.h)return e.u(t,r._);if(a)o(t,a);else for(t.y=v,t.v=n;++u<c;)t.b[u].x(n);return t},e.u=function(e,t){e.y=b,e.v=t;for(var n=-1,r=e.b.length;++n<r;)e.b[n].I(t);return e},e}()},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=function(){function e(){this.j=[],this.R={},this.ai=1,this.doAI=!1}return e.prototype.set=function(e){var t=this;if(this.j=e||[],this.R={},this.j.forEach(function(e,n){t.R[String(e)]=n}),this.doAI&&this.j.length){var n=this.j.length;this.ai=this.j[n-1]+1}},e.prototype.getLocation=function(e){var t=this.indexOf(e);return-1!==t?t:r.binarySearch(this.j,e)},e.prototype.add=function(e){if(this.doAI)parseInt(e)>=this.ai&&this.ai++,this.R[String(e)]=this.j.length,this.j.push(e);else{var t=r.binarySearch(this.j,e);this.j.splice(t,0,e),this.R[String(e)]=t;for(var n=t+1;n<this.j.length;n++)this.R[String(this.j[n])]++}},e.prototype.keys=function(){return this.j},e.prototype.indexOf=function(e){return void 0!==this.R[String(e)]?this.R[String(e)]:-1},e.prototype.remove=function(e){var t=this.R[String(e)];if(void 0!==t){delete this.R[String(e)],this.j.splice(t,1);for(var n=t;n<this.j.length;n++)this.R[String(this.j[n])]--}},e}();t.DatabaseIndex=i},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(5),s=n(6),a=n(7),u=n(0),c=n(8),f=n(16),h=["_util"],l=function(){function e(){this.version=1.06;var e=this;e.P={},e.L={},e.C={},e.M=["*","change","delete","upsert","drop","select","error"],e.N={},e.B=[],e.D=[],e.K=[],e.Q=[],e.H=0,e.F=0,e.hasAnyEvents=!1;for(var t=0;t<100;t++)e.K.push(u.random16Bits().toString(16)),e.Q.push(new o.W(e));e.J={},e.J["*"]=new a.ReallySmallEvents,e.V=new c.NanoSQLDefaultBackend;var n={models:{},actions:{},views:{},config:{},parent:this};e.V.willConnect&&e.V.willConnect(n,function(){e.V.didConnect&&e.V.didConnect(n,function(){})})}return e.prototype.fastRand=function(){return this.F++,this.F>=this.K.length&&(this.F=0),this.K[this.F]},e.prototype.table=function(e){return e&&(this.sTable=e),this},e.prototype.connect=function(){var e=this,t=this;return new u.t(function(n,r){var i={models:t.C,actions:t.P,views:t.L,config:t.U,parent:e};i.models[h[0]]=[{key:"key",type:"string",props:["pk","ai"]},{key:"value",type:"any"}],e.D=[],t.U&&t.U.history&&e.use(new f.z(t.U.historyMode)),t.U&&!1===t.U.mode||e.use(new c.NanoSQLDefaultBackend),u.fastCHAIN(e.D,function(e,t,n){e.willConnect?e.willConnect(i,function(e){i=e,n()}):n()}).then(function(){e.C=i.models,e.P=i.actions,e.L=i.views,e.U=i.config,e.D.forEach(function(t){t.didExec&&(e.pluginsDoHasExec=!0)}),t.B=Object.keys(e.C);var r=function(){u.fastALL(e.D,function(e,t,n){e.didConnect?e.didConnect(i,function(){n()}):n()}).then(function(){n(t.B)})},o=function(t){e.query("upsert",{key:"version",value:e.version}).manualExec({table:"_util"}).then(function(){t?e.extend("rebuild_idx").then(function(){r()}):r()})};e.query("select").where(["key","=","version"]).manualExec({table:"_util"}).then(function(e){e.length?e[0].value<1.11?o(!1):r():o(!0)})})})},e.prototype.getConfig=function(){return u.r(this.U||{})},e.prototype.avFilter=function(e){return this.G=e,this},e.prototype.use=function(e){return this.D.push(e),this},e.prototype.on=function(e,t){var n=this,r=n.sTable,i=n.M.length,o=e.split(" ");if(Array.isArray(r))return this;for(n.J[r]||(n.J[r]=new a.ReallySmallEvents),i=o.length;i--;)-1!==n.M.indexOf(o[i])&&n.J[r].on(o[i],t);return n.X()},e.prototype.off=function(e,t){var n=this,r=e.split(" "),i=r.length,o=n.sTable;if(Array.isArray(o))return this;for(;i--;)-1!==n.M.indexOf(r[i])&&n.J[o].off(r[i],t);return n.X()},e.prototype.X=function(){var e=this;return this.N={},Object.keys(this.J).concat(["*"]).forEach(function(t){e.N[t]=e.M.reduce(function(n,r){return n+(e.J[t]&&e.J[t].eventListeners[r]?e.J[t].eventListeners[r].length:0)},0)>0}),this.hasAnyEvents=!1,Object.keys(this.N).forEach(function(t){e.hasAnyEvents=e.hasAnyEvents||e.N[t]}),this},e.prototype.model=function(e){var t=this,n=t.sTable;return Array.isArray(n)?this:(t.J[n]||(t.J[n]=new a.ReallySmallEvents),t.C[n]=e,t.L[n]=[],t.P[n]=[],t)},e.prototype.views=function(e){return Array.isArray(this.sTable)?this:(this.L[this.sTable]=e,this)},e.prototype.getView=function(e,t){return void 0===t&&(t={}),Array.isArray(this.sTable)?new u.t(function(e,t){return t()}):this.Y("View",this.L[this.sTable],e,t)},e.prototype.actions=function(e){return Array.isArray(this.sTable)?this:(this.P[this.sTable]=e,this)},e.prototype.doAction=function(e,t){return Array.isArray(this.sTable)?new u.t(function(e,t){return t()}):this.Y("Action",this.P[this.sTable],e,t)},e.prototype.queryFilter=function(e){return this.$=e,this},e.prototype.Y=function(e,t,n,r){var i=this,o=this,s=t.reduce(function(e,t){return t.name===n?t:e},null);return s?(o.Z=n,o.G?new u.t(function(t,n){o.G(i.sTable,e,o.Z||"",r,function(e){s.call(s.args?u.cleanArgs(s.args,e):{},o).then(t).catch(n)},function(e){n(e)})}):s.call(s.args?u.cleanArgs(s.args,r):{},o)):new u.t(function(e,t){return t("Action/View Not Found!")})},e.prototype.query=function(e,t){var n=this;++n.H>n.Q.length-1&&(n.H=0);var r=n.Z;return n.Z=void 0,n.Q[n.H].set(n.sTable,e.toLowerCase(),t,r)},e.prototype.triggerEvent=function(e){var t=this;return(t.N["*"]||t.N[e.table])&&i.setFast(function(){e.types.forEach(function(n){t.J["*"].trigger(n,e,t),t.J["*"].trigger("*",e,t),e.table&&t.J[e.table]&&t.J[e.table].trigger(n,e,t)})}),t},e.prototype.default=function(e){var t={},n=this;return Array.isArray(n.sTable)?{}:(n.C[n.sTable].forEach(function(n){t[n.key]=e&&e[n.key]?e[n.key]:n.default,void 0===t[n.key]&&(t[n.key]=u.cast(n.type,null))}),t)},e.prototype.doTransaction=function(e){var t=this,n=this,i=[],o=u.random16Bits().toString(16);return new u.t(function(a,c){if(!n.D.length)return void c("Nothing to do, no plugins!");u.fastCHAIN(n.D,function(e,t,n){e.transactionBegin?e.transactionBegin(o,n):n()}).then(function(){Array.isArray(n.sTable)||e(function(e){var t=e||n.sTable;return{query:function(e,n){return new s.ee(e,n,t,i,o)}}},function(){var e=[];u.fastCHAIN(i,function(t,i,s){e.push(t.table),n.query(t.action,t.actionArgs).manualExec(r({},t,{table:t.table,transaction:!0,queryID:o})).then(s)}).then(function(r){u.fastCHAIN(t.D,function(e,t,n){e.transactionEnd?e.transactionEnd(o,n):n()}).then(function(){e.filter(function(e,t,n){return n.indexOf(e)===t}).forEach(function(e){0!==e.indexOf("_")&&n.triggerEvent({query:i[0],table:e,time:(new Date).getTime(),result:r,types:["transaction"],actionOrView:"",notes:[],transactionID:o,affectedRowPKS:[],affectedRows:[]})}),a(r)})})})})})},e.prototype.config=function(e){return this.U=e,this},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;return new u.t(function(t,r){if(n.D.length){var i=u.r(e),o=[];u.fastCHAIN(n.D,function(e,t,n){e.extend?e.extend(function(e,t){i=e,o=t,n()},i,o):n()}).then(function(){t(o)})}else r("No plugins!")})},e.prototype.loadJS=function(e,n,r){void 0===r&&(r=!0);var i=this;return r?i.doTransaction(function(t,r){n.forEach(function(n){t(e).query("upsert",n).exec()}),r()}):new u.t(function(r,i){u.fastCHAIN(n,function(n,r,i){t.nSQL().query("upsert",n).manualExec({table:e}).then(i)}).then(function(e){r(e.map(function(e){return e.shift()}))})})},e.prototype.loadCSV=function(e,n,r){void 0===r&&(r=!0);var i=this,o=[],s=n.split("\n").map(function(e,t){if(0===t)return void(o=e.split(","));for(var n={},r=e.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[],i=o.length;i--;)1===r[i].indexOf("{")||1===r[i].indexOf("[")?r[i]=JSON.parse(r[i].slice(1,r[i].length-1).replace(/'/gm,'"')):0===r[i].indexOf('"')&&(r[i]=r[i].slice(1,r[i].length-1)),n[o[i]]=r[i];return n}).filter(function(e){return e});return r?i.doTransaction(function(t,n){s.forEach(function(n){t(e).query("upsert",n).exec()}),n()}):new u.t(function(n,r){u.fastCHAIN(s,function(n,r,i){t.nSQL().query("upsert",n).manualExec({table:e}).then(i)}).then(function(e){n(e.map(function(e){return e.shift()}))})})},e}();t.NanoSQLInstance=l,l.functions={COUNT:{type:"A",call:function(e,t,n){t(n&&"*"!==n?e.filter(function(e){return u.objQuery(n,e)}).length:e.length)}},MAX:{type:"A",call:function(e,t,n){if(e.length){var r=u.objQuery(n,e[0])||0;e.forEach(function(e){u.objQuery(n,e),u.objQuery(n,e)>r&&(r=u.objQuery(n,e))}),t(r)}else t(0)}},MIN:{type:"A",call:function(e,t,n){if(e.length){var r=u.objQuery(n,e[0])||0;e.forEach(function(e){var t=u.objQuery(n,e);t<r&&(r=t)}),t(r)}else t(0)}},AVG:{type:"A",call:function(e,t,n){t(e.reduce(function(e,t){return e+(u.objQuery(n,t)||0)},0)/e.length)}},SUM:{type:"A",call:function(e,t,n){t(e.reduce(function(e,t){return e+(u.objQuery(n,t)||0)},0))}},LOWER:{type:"S",call:function(e,t,n){t(e.map(function(e){return String(u.objQuery(n,e)).toLowerCase()}))}},UPPER:{type:"S",call:function(e,t,n){t(e.map(function(e){return String(u.objQuery(n,e)).toUpperCase()}))}},CAST:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return u.cast(r,u.objQuery(n,e))}))}},ABS:{type:"S",call:function(e,t,n){t(e.map(function(e){return Math.abs(u.objQuery(n,e))}))}},CEIL:{type:"S",call:function(e,t,n){t(e.map(function(e){return Math.ceil(u.objQuery(n,e))}))}},POW:{type:"S",call:function(e,t,n,r){t(e.map(function(e){return Math.pow(u.objQuery(n,e),parseInt(r))}))}},ROUND:{type:"S",call:function(e,t,n){t(e.map(function(e){return Math.round(u.objQuery(n,e))}))}},SQRT:{type:"S",call:function(e,t,n){t(e.map(function(e){return Math.sqrt(u.objQuery(n,e))}))}}};var _=new l;t.nSQL=function(e){return _.table(e)}},function(e,t,n){e.exports=n(3)},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o={affectedRowPKS:[],affectedRows:[]},s=function(e,t){1!==e.te.D.length||e.te.hasAnyEvents?i.fastCHAIN(e.te.D,function(t,n,r){t.doExec?t.doExec(e.ne,function(t){e.ne=t||e.ne,r()}):r()}).then(function(){if(t(e.ne.result),e.te.hasAnyEvents||e.te.pluginsDoHasExec){var n=function(){switch(e.ne.action){case"select":return[e.ne.action];case"delete":case"upsert":case"drop":return[e.ne.action,"change"];default:return[]}}(),r=e.ne.result&&e.ne.result.length,s={table:e.ne.table,query:e.ne,time:Date.now(),result:e.ne.result,notes:[],types:n,actionOrView:e.re,transactionID:e.ne.transaction?e.ne.queryID:void 0,affectedRowPKS:r?(e.ne.result[0]||o).affectedRowPKS:[],affectedRows:r?(e.ne.result[0]||o).affectedRows:[]};i.fastCHAIN(e.te.D,function(e,t,n){e.didExec?e.didExec(s,function(e){s=e,n()}):n()}).then(function(){e.te.triggerEvent(s)})}}):e.te.D[0].doExec(e.ne,function(n){e.ne=n,t(e.ne.result)})},a=function(){function e(e){this.te=e}return e.prototype.set=function(e,t,n,r){return this.re=r||"",this.ne={table:e,comments:[],state:"pending",queryID:Date.now()+"."+this.te.fastRand(),action:t,actionArgs:n,result:[]},this},e.prototype.where=function(e){return this.ne.where=e,this},e.prototype.range=function(e,t){return this.ne.range=[e,t],this},e.prototype.orm=function(e){return this.ne.orm=e,this},e.prototype.orderBy=function(e){return this.ne.orderBy=e,this},e.prototype.groupBy=function(e){return this.ne.groupBy=e,this},e.prototype.having=function(e){return e.length&&Array.isArray(e)||(this.ie="Having condition requires an array!"),this.ne.having=e,this},e.prototype.join=function(e){if(Array.isArray(this.ne.table))throw Error("Can't JOIN with instance table!");return e.table&&e.type||(this.ie="Join command requires table and type arguments!"),this.ne.join=e,this},e.prototype.limit=function(e){return this.ne.limit=e,this},e.prototype.trieSearch=function(e,t){return this.ne.trie={column:e,search:t},this},e.prototype.comment=function(e){return this.ne.comments.push(e),this},e.prototype.extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.ne.extend=e,this},e.prototype.offset=function(e){return this.ne.offset=e,this},e.prototype.toCSV=function(e){var t=this;return new i.t(function(n,r){t.exec().then(function(r){var i=[];r.length||n("",t),e&&i.push(Object.keys(r[0]).join(",")),r.forEach(function(e){i.push(Object.keys(e).map(function(t){return null===e[t]||void 0===e[t]?"":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,"'")+'"':e[t]}).join(","))}),n(i.join("\n"),t)})})},e.prototype.manualExec=function(e){return this.ne=r({},this.ne,e),this.exec()},e.prototype.exec=function(){var e=this,t=this,n=this.ne.action.toLowerCase();if(!(["select","upsert","delete","drop","show tables","describe"].indexOf(n)>-1))throw Error("No valid database action!");var r=this.ne.actionArgs||("select"===n||"delete"===n?[]:{});if("upsert"===n){for(var o={},a=this.te.C[this.ne.table],u=0;u<a.length;)void 0!==r[a[u].key]&&(o[a[u].key]=i.cast(a[u].type,r[a[u].key])),u++;r=o}return this.ne.action=n,this.ne.actionArgs=this.ne.actionArgs?r:void 0,new i.t(function(n,r){return Array.isArray(e.ne.table)?void(e.te.V.doExec&&e.te.V.doExec(e.ne,function(e){n(e.result)})):(t.te.D.length||(t.ie="No plugins, nothing to do!"),t.ie?void r(t.ie,e.te):void(e.te.$?e.te.$(e.ne,function(t){e.ne=t,s(e,n)}):s(e,n)))})},e}();t.W=a},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n,r,i){this.thisQ={state:"pending",table:n,action:e,actionArgs:t,queryID:i,transaction:!0,result:[],comments:[]},this.oe=r}return e.prototype.where=function(e){return this.thisQ.where=e,this},e.prototype.exec=function(){this.oe.push(this.thisQ)},e}();t.ee=n},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var n=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(r,i){r===t&&n.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=n,t.RSE=new n},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(9),o=n(15),s=n(0),a=function(){function e(){this.Q=[],this.H=0}return e.prototype.willConnect=function(e,t){this.parent=e.parent,this.se=new i.ae(e.parent,r({},e.config));for(var n=0;n<100;n++)this.Q.push(new o.ue(this.se));this.se.init(e.models,function(n){e.models=r({},e.models,n),t(e)})},e.prototype.doExec=function(e,t){e.state="complete",this.H++,this.H>this.Q.length-1&&(this.H=0),this.Q[this.H].doQuery(e,t)},e.prototype.extend=function(e,t,n){var r=this;switch(t[0]){case"idx.length":case"idx":var i=t[1];Object.keys(this.se.tableInfo).indexOf(i)>-1?this.se.ce.getIndex(i,"idx"!==t[0],function(n){e(t,n)}):e(t,[]);break;case"rebuild_idx":t[1]?this.se.rebuildIndexes(t[1],function(n){e(t,[n])}):s.fastALL(Object.keys(this.se.tableInfo),function(e,t,n){r.se.rebuildIndexes(e,n)}).then(function(n){e(t,n)});break;case"clear_cache":t[1]?this.se.fe[t[1]]={}:Object.keys(this.se.tableInfo).forEach(function(e){r.se.fe[e]={}}),e(t,t[1]||Object.keys(this.se.tableInfo));break;default:e(t,n)}},e}();t.NanoSQLDefaultBackend=a},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(10),o=n(0),s=n(11),a=n(12),u=n(14),c=function(){function e(e,t){if(this.B=[],this.he=e,this.le=t.persistent?"PERM":t.mode||"TEMP",this._e=t.id,this.de=t.size,this.models={},this.tableInfo={},this.pe={},this.B=[],this.ye=t.cache||!0,this.fe={},this.be={},"string"==typeof this.le){if("PERM"===this.le){var n=this.ve();this.le=n||this.le}switch(this.le){case"IDB":this.ce=new a.ge(!1);break;case"IDB_WW":this.ce=new a.ge(!0);break;case"WSQL":this.ce=new u.me(this.de);break;case"LS":this.ce=new s.we(!0);break;case"TEMP":this.ce=new s.we(!1)}}else this.ce=this.le}return e.prototype.init=function(e,t){var n=this;this._e||(this._e=o.hash(JSON.stringify(e)).toString()),this.ce.setID(this._e),this.models=this.xe(e),this.B=Object.keys(this.models),this.B.forEach(function(t){n.qe(t,e[t])}),this.Oe={},this.ke={},this.Ie={},this.Ee={},this.B.forEach(function(e){var t=n.models[e].length;for(n.Oe[e]={},n.Ie[e]=[],n.ke[e]=[],n.Ee[e]={};t--;)!function(){var r=n.models[e][t];if(-1!==n.B.indexOf(r.type.replace("[]",""))){var i="";n.Ee[e][r.key]={Ae:r.type.replace("[]",""),Se:-1===r.type.indexOf("[]")?"single":"array"},r.props&&(r.props.forEach(function(e){-1!==e.indexOf("ref=>")&&(i=e.replace("ref=>",""))}),i&&(n.je=!0,n.Ie[e].push(r.key),n.Oe[e][r.key]={Ae:r.type.replace("[]",""),Re:i.replace("[]",""),Te:-1===i.indexOf("[]")?"single":"array",Se:-1===r.type.indexOf("[]")?"single":"array"}))}}()}),Object.keys(this.Oe).forEach(function(e){Object.keys(n.Oe[e]).forEach(function(t){var r=n.Oe[e][t];n.ke[r.Ae].push({Pe:r.Re,Se:r.Te,Le:e,Ce:t,Me:r.Se})})}),this.ce.connect(function(){o.fastALL(Object.keys(n.pe),function(e,t,r){var i=n.pe[e];Object.keys(i).length?n.Ne(e,function(t,r,o){if(!t)return void o(!1);Object.keys(i).forEach(function(r){void 0!==t[r]&&n.pe[e][r].addWord(String(t[r]))}),o(!1)},r):r()}).then(function(){t(n.models)})})},e.prototype.rebuildIndexes=function(e,t){var n=this,r=(new Date).getTime();o.fastALL(Object.keys(this.tableInfo),function(t,r,i){if("_ALL_"!==e&&e!==t||0===t.indexOf("_"))return void i();var s=n.tableInfo[t].Be;o.fastALL(s,function(e,r,i){var o="_"+t+"_idx_"+e,s=n.tableInfo[t].De;n.Ke(o,function(){n.Ne(t,function(e,r,i){n.Qe(t,e[s],e,[],function(){i(!1)})},i)})}).then(i)}).then(function(){t((new Date).getTime()-r)})},e.prototype.He=function(e){return o.isObject(e)||Array.isArray(e)?JSON.stringify(e).substr(0,12):"number"==typeof e?e:String(e).substr(0,32)},e.prototype.ve=function(){if("undefined"==typeof window)return"LVL";if(o.isSafari)return"WSQL";if(o.isMSBrowser)return"undefined"!=typeof indexedDB?"IDB":"LS";if(-1===[typeof Worker,typeof Blob,typeof indexedDB].indexOf("undefined")&&window.URL&&window.URL.createObjectURL)try{var e=new Worker(window.URL.createObjectURL(new Blob(["var t = 't';"])));return e.postMessage(""),e.terminate(),indexedDB.open("1234",1),indexedDB.deleteDatabase("1234"),"IDB_WW"}catch(e){if("undefined"!=typeof indexedDB)return"IDB"}return"LS"},e.prototype.Fe=function(e,t,n,r){var i=this;this.ce.read("_"+e+"_idx_"+t,this.He(n),function(t){void 0!==t?i.Ne(e,t.rows||[],r):r([])})},e.prototype.We=function(e,t,n,r){var i=[];this.ce.rangeRead(e,function(e,t,n){i.push(e),n()},function(){r(i)},t,n)},e.prototype.Je=function(e,t,n,r){var i=[];this.ce.rangeRead(e,function(e,t,n){i.push(e),n()},function(){r(i)},t,n,!0)},e.prototype.Ne=function(e,t,n){var r=this;if(Array.isArray(t))return void o.fastALL(t,function(t,n,i){r.ce.read(e,t,i)}).then(function(e){n(e.filter(function(e){return e}))});var i=[];return"function"==typeof t?void this.ce.rangeRead(e,function(e,n,r){t(e,n,function(t){t&&i.push(e),r()})},function(){n(i)}):void 0},e.prototype.Ve=function(e,t,n,r){var i=this,s=this.pe[e][t].getPrefix(n);o.fastALL(s,function(n,r,o){i.Fe(e,t,n,o)}).then(function(e){r([].concat.apply([],e))})},e.prototype.Ue=function(e,t,n,r,i){var s=this;o.fastALL(this.tableInfo[e].Be.filter(function(e){return-1===r.indexOf(e)}),function(r,i,a){var u=s.He(n[r]),c="_"+e+"_idx_"+r;s.ce.read(c,u,function(e){if(!e)return void a();var n=e.rows.indexOf(t);if(-1===n)return void a();var r=e?Object.isFrozen(e)?o.r(e):e:{id:null,rows:[]};r.rows.splice(n,1),r.rows.sort(),r.rows=o.removeDuplicates(r.rows),s.ce.write(c,r.id,r,a,!0)})}).then(i)},e.prototype.Qe=function(e,t,n,r,i){var s=this;o.fastALL(this.tableInfo[e].Be.filter(function(e){return-1===r.indexOf(e)}),function(r,i,a){var u=s.He(n[r]);s.pe[e][r]&&s.pe[e][r].addWord(String(n[r]));var c="_"+e+"_idx_"+r;s.ce.read(c,u,function(e){var n=e?Object.isFrozen(e)?o.r(e):e:{id:u,rows:[]};n.rows.push(t),n.rows.sort(),n.rows=o.removeDuplicates(n.rows),s.ce.write(c,u,n,a,!0)})}).then(i)},e.prototype.ze=function(e,t,n,i,o){var s=this;if(n){var a=r({},n,i,(c={},c[this.tableInfo[e].De]=t,c)),u=Object.keys(a).filter(function(e){return a[e]===n[e]});this.tableInfo[e].Be.length?this.Ue(e,t,n,u,function(){s.Qe(e,t,a,u,function(){s.ce.write(e,t,a,o,!0)})}):this.ce.write(e,t,a,o,!0)}else this.ce.write(e,t,i,function(t){s.tableInfo[e].Be.length?s.Qe(e,t[s.tableInfo[e].De],i,[],function(){o(t)}):o(t)},!0);var c},e.prototype.Ge=function(e,t,n){var r=this;if(!t)throw new Error("Can't delete without a primary key!");this.ce.read(e,t,function(i){r.Ue(e,t,i,[],function(){r.ce.delete(e,t,function(){n(i)})})})},e.prototype.Ke=function(e,t){var n=this;o.fastALL(this.tableInfo[e].Be,function(t,r,i){n.ce.drop("_"+e+"_idx_"+t,i)}).then(function(){n.pe[e]={},n.tableInfo[e].Xe.forEach(function(t){n.pe[e][t]=new i.Trie([])}),n.ce.drop(e,t)})},e.prototype.xe=function(e){return Object.keys(e).forEach(function(t){var n=!1,r=!1;if(e[t].forEach(function(i){i.props&&i.props.indexOf("pk")>-1&&(n=!0),i.props&&(i.props.indexOf("idx")>-1||i.props.indexOf("trie")>-1)&&(r=!0,e["_"+t+"_idx_"+i.key]=[{key:"id",type:"string",props:["pk"]},{key:"rows",type:"any[]"}])}),r&&!n)throw new Error("Tables with secondary indexes must have a primary key!")}),e},e.prototype.qe=function(e,t){this.tableInfo[e]={De:"",Ye:"",$e:[],Ze:[],Be:[],Xe:[],et:e},this.fe[e]={},this.be[e]={},this.pe[e]={},this.ce.makeTable(e,t);for(var n=this.models[e].length;n--;){var r=this.models[e][n];this.tableInfo[e].$e.unshift(r.key),this.tableInfo[e].Ze[n]=r.default,r.props&&r.props.indexOf("pk")>-1&&(this.tableInfo[e].De=r.key,this.tableInfo[e].Ye=r.type),r.props&&(r.props.indexOf("idx")>-1||r.props.indexOf("trie")>-1)&&this.tableInfo[e].Be.push(r.key),r.props&&r.props.indexOf("trie")>=0&&(this.tableInfo[e].Xe.push(r.key),this.pe[e][r.key]=new i.Trie([]))}return e},e}();t.ae=c},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n={END_WORD:"$",PERMS_MIN_LEN:2},r=function(){function e(t){this.tt=e.nt(t)}return e.prototype.addWord=function(t){var n=function(t,n,r,i){return e.rt(t,n,r,i)};return t.toLowerCase().split("").reduce(n,this.tt),this},e.prototype.removeWord=function(t){var r=e.it(this.tt,t),i=r.prefixFound,o=r.prefixNode;return i&&delete o[n.END_WORD],this},e.prototype.getWords=function(){return e.ot(this.tt,"")},e.prototype.getPrefix=function(t){if(t=t.toLowerCase(),!this.st(t))return[];var n=e.it(this.tt,t).prefixNode;return e.ot(n,t)},e.prototype.st=function(t){return e.it(this.tt,t).prefixFound},e.rt=function(e,t,r,i){return e[t]=e[t]||{},e=e[t],r===i.length-1&&(e[n.END_WORD]=1),e},e.it=function(e,t){return{prefixFound:t.toLowerCase().split("").every(function(t,n){return!!e[t]&&(e=e[t])}),prefixNode:e}},e.nt=function(t){return(t||[]).reduce(function(t,n){return n.toLowerCase().split("").reduce(e.rt,t),t},{})},e.ot=function(t,r,i){void 0===i&&(i=[]);var o=r;for(var s in t)s===n.END_WORD&&(i.push(o),o=""),e.ot(t[s],r+s,i);return i.sort()},e}();t.Trie=r},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function e(e){this.at={},this.Ye={},this.ut={},this.ct={},this.ft=e||!1}return e.prototype.connect=function(e){e()},e.prototype.setID=function(e){this._e=e},e.prototype.makeTable=function(e,t){var n=this;this.ut[e]={},this.ct[e]=new s.DatabaseIndex,t.forEach(function(t){if(t.props&&t.props.indexOf("pk")>-1&&(n.Ye[e]=t.type,n.at[e]=t.key),t.props&&t.props.indexOf("ai")>-1&&t.props.indexOf("pk")>-1&&"int"===t.type&&(n.ct[e].doAI=!0),n.ft){var r=localStorage.getItem(n._e+"*"+e+"_idx");r&&n.ct[e].set(JSON.parse(r))}})},e.prototype.write=function(e,t,n,i,s){if(!(t=t||o.generateID(this.Ye[e],this.ct[e].ai)))throw new Error("Can't add a row without a primary key!");if(-1===this.ct[e].indexOf(t)&&(this.ct[e].add(t),this.ft&&localStorage.setItem(this._e+"*"+e+"_idx",JSON.stringify(this.ct[e].keys()))),this.ft){var a=r({},s?{}:JSON.parse(localStorage.getItem(this._e+"*"+e+"__"+t)||"{}"),n,(u={},u[this.at[e]]=t,u));localStorage.setItem(this._e+"*"+e+"__"+t,JSON.stringify(a)),i(a)}else{var a=r({},s?{}:this.ut[e][t],n,(c={},c[this.at[e]]=t,c));this.ut[e][t]=o.deepFreeze(a),i(a)}var u,c},e.prototype.delete=function(e,t,n){-1!==this.ct[e].indexOf(t)&&(this.ct[e].remove(t),this.ft&&localStorage.setItem(this._e+"*"+e+"_idx",JSON.stringify(this.ct[e].keys()))),this.ft?localStorage.removeItem(this._e+"*"+e+"__"+t):delete this.ut[e][t],n()},e.prototype.read=function(e,t,n){if(this.ft){var r=localStorage.getItem(this._e+"*"+e+"__"+t);n(r?JSON.parse(r):void 0)}else n(this.ut[e][t])},e.prototype.rangeRead=function(e,t,n,r,o,s){var a=this,u=this.ct[e].keys(),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[0,u.length-1];if(!u.length)return void n();s&&c&&(f=f.map(function(t){return a.ct[e].getLocation(t)}));var h=f[0],l=0,_=function(){h++,l++,l>1e3?i.setFast(d):d()},d=function(){if(h<=f[1])if(a.ft){var r=localStorage.getItem(a._e+"*"+e+"__"+u[h]);t(r?JSON.parse(r):void 0,h,_)}else t(a.ut[e][u[h]],h,_);else n()};d()},e.prototype.drop=function(e,t){var n=this;this.ft?(localStorage.setItem(this._e+"*"+e+"_idx",JSON.stringify([])),this.ct[e].keys().forEach(function(t){localStorage.removeItem(n._e+"*"+e+"__"+t)})):this.ut[e]={};var r=new s.DatabaseIndex;r.doAI=this.ct[e].doAI,this.ct[e]=r,t()},e.prototype.getIndex=function(e,t,n){n(t?this.ct[e].keys().length:this.ct[e].keys())},e.prototype.destroy=function(e){var t=this;o.fastALL(Object.keys(this.ct),function(e,n,r){t.drop(e,r)}).then(e)},e}();t.we=a},function(module,exports,__webpack_require__){var __assign=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(exports,"__esModule",{value:!0});var lie_ts_1=__webpack_require__(1),utilities_1=__webpack_require__(0),db_idx_1=__webpack_require__(2),_evalContext=function(source,context){var compiled=eval("(function("+Object.keys(context).join(", ")+") {"+source+"})");return compiled.apply(context,Object.keys(context).map(function(e){return context[e]}))},_IndexedDBStore=function(){function e(e){this.ht=__webpack_require__(13),this.at={},this.Ye={},this.ct={},this.lt={},this._t=e}return e.prototype.connect=function(e){var t=this;if(this._t)this.dt=new Worker(window.URL.createObjectURL(new Blob([this.ht]))),this.dt.addEventListener("message",function(e){t.pt(e.data.do,e.data.args)});else{var n=[];_evalContext(this.ht,{postMessage:function(e){t.pt(e.do,e.args)},addEventListener:function(e,t){n.push(t)}}),this.dt={addEventListener:null,postMessage:function(e,t){n.forEach(function(t){t({data:e})})}}}this.lt.rdy=function(n){Object.keys(n).forEach(function(e){t.ct[e].set(n[e])}),e()},this.dt.postMessage({do:"setup",args:{pkKeys:this.at,id:this._e}})},e.prototype.setID=function(e){this._e=e},e.prototype.pt=function(e,t){this.lt[e]&&(this.lt[e](t),delete this.lt[e])},e.prototype.makeTable=function(e,t){var n=this;this.ct[e]=new db_idx_1.DatabaseIndex,t.forEach(function(t){t.props&&t.props.indexOf("pk")>-1&&(n.Ye[e]=t.type,n.at[e]=t.key,t.props&&t.props.indexOf("ai")>-1&&("int"===t.type||"number"===t.type)&&(n.ct[e].doAI=!0))})},e.prototype.write=function(e,t,n,r,i){var o=this;if(!(t=t||utilities_1.generateID(this.Ye[e],this.ct[e].ai)))throw new Error("Can't add a row without a primary key!");-1===this.ct[e].indexOf(t)&&this.ct[e].add(t);var s=utilities_1.uuid(),a=__assign({},n,(c={},c[this.at[e]]=t,c));this.lt["write_"+s]=function(e){r(a)};var u=function(t){a=__assign({},t,a),o.dt.postMessage({do:"write",args:{table:e,id:s,row:a}})};i?u({}):this.read(e,t,function(e){u(e)});var c},e.prototype.delete=function(e,t,n){-1!==this.ct[e].indexOf(t)&&this.ct[e].remove(t);var r=utilities_1.uuid();this.lt["delete_"+r]=function(e){n()},this.dt.postMessage({do:"delete",args:{table:e,id:r,pk:t}})},e.prototype.read=function(e,t,n){var r=utilities_1.uuid();if(-1===this.ct[e].indexOf(t))return void n(null);this.lt["read_"+r]=function(e){n(e)},this.dt.postMessage({do:"read",args:{table:e,id:r,pk:t}})},e.prototype.rangeRead=function(e,t,n,r,i,o){var s=this,a=this.ct[e].keys(),u=-1===[typeof r,typeof i].indexOf("undefined"),c=u?[r,i]:[0,a.length-1];if(!a.length)return void n();var f=utilities_1.uuid(),h=[],l=c[0],_=0;this.lt["readRange_"+f+"_done"]=function(e){delete s.lt["readRange_"+f],h=e;var r=function(){l<=c[1]?t(h[_],l,function(){l++,_++,_>1e3?lie_ts_1.setFast(r):r()}):n()};r()},this.dt.postMessage({do:"readRange",args:{table:e,id:f,range:o&&u?c:c.map(function(e){return a[e]})}})},e.prototype.drop=function(e,t){var n=new db_idx_1.DatabaseIndex;n.doAI=this.ct[e].doAI,this.ct[e]=n;var r=utilities_1.uuid();this.lt["delete_"+r]=function(e){t()},this.dt.postMessage({do:"delete",args:{table:e,id:r,pk:"_clear_"}})},e.prototype.getIndex=function(e,t,n){n(t?this.ct[e].keys().length:this.ct[e].keys())},e.prototype.destroy=function(e){var t=this;utilities_1.fastALL(Object.keys(this.ct),function(e,n,r){t.drop(e,r)}).then(e)},e}();exports.ge=_IndexedDBStore},function(e,t){e.exports='function e(e){this.go=function(n){var t=0;e&&e.length||n([]),e.forEach(function(o,r){o(function(){++t===e.length&&n([])})})}}var n={db:null,store:function(e,t,o){var r=n.db.transaction(e,t);o(r,r.objectStore(e),function(e,n){return function(){postMessage({do:e,args:n})}})},init:function(){addEventListener("message",function(e){var t=e.data;n[t.do]&&n[t.do](t.args)},!1)},setup:function(t){var o=indexedDB.open(t.id,1),r=!1,a={};o.onupgradeneeded=function(e){r=!0,n.db=e.target.result,Object.keys(t.pkKeys).forEach(function(e){n.db.createObjectStore(e,{keyPath:t.pkKeys[e]}),a[e]=[]})},o.onsuccess=function(o){if(n.db=o.target.result,r)postMessage({do:"rdy",args:a});else{var s=function(e,t){var o=[];n.store(e,"readonly",function(e,n,r){n.openCursor().onsuccess=function(e){var n=e.target.result;n&&(o.push(n.key),n.continue())},e.oncomplete=function(){t(o)}})};new e(Object.keys(t.pkKeys).map(function(e){return function(n){s(e,function(t){a[e]=t,n()})}})).go(function(){postMessage({do:"rdy",args:a})})}}},write:function(e){n.store(e.table,"readwrite",function(n,t,o){t.put(e.row),n.oncomplete=o("write_"+e.id,null)})},read:function(e){n.store(e.table,"readonly",function(n,t,o){var r=t.get(e.pk);r.onsuccess=function(){postMessage({do:"read_"+e.id,args:r.result})}})},readRange:function(e){n.store(e.table,"readonly",function(n,t,o){var r=[],a=-1===e.range.indexOf(void 0)?t.openCursor(IDBKeyRange.bound(e.range[0],e.range[1])):t.openCursor();n.oncomplete=o("readRange_"+e.id+"_done",r),a.onsuccess=function(e){var n=e.target.result;n&&(r.push(n.value),n.continue())}})},delete:function(e){n.store(e.table,"readwrite",function(n,t,o){n.oncomplete=o("delete_"+e.id,!0),n.onerror=o("delete_"+e.id,!1),"_clear_"===e.pk?t.clear():t.delete(e.pk)})}};n.init();'},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(0),s=n(2),a=function(){function e(e){this.at={},this.Ye={},this.ct={},this.de=1e3*(e||0)*1e3}return e.prototype.setID=function(e){this._e=e},e.prototype.connect=function(e){var t=this;this.te=window.openDatabase(this._e,"1.0",this._e,this.de||o.isAndroid?5e6:1),o.fastALL(Object.keys(this.at),function(e,n,r){t.yt(!0,"CREATE TABLE IF NOT EXISTS "+e+" (id BLOB PRIMARY KEY UNIQUE, data TEXT)",[],function(){t.yt(!1,"SELECT id FROM "+e,[],function(n){for(var i=[],o=0;o<n.rows.length;o++)i.push(n.rows.item(o).id);i=i.sort(),t.ct[e].set(i),r()})})}).then(e)},e.prototype.bt=function(e){if(-1===Object.keys(this.Ye).indexOf(e))throw Error("No table "+e+" found!");return e},e.prototype.makeTable=function(e,t){var n=this;this.ct[e]=new s.DatabaseIndex,t.forEach(function(t){t.props&&t.props.indexOf("pk")>-1&&(n.Ye[e]=t.type,n.at[e]=t.key),t.props&&t.props.indexOf("ai")>-1&&t.props.indexOf("pk")>-1&&"int"===t.type&&(n.ct[e].doAI=!0)})},e.prototype.yt=function(e,t,n,r){var i=function(e){e.executeSql(t,n,function(e,t){r(t)},function(e,r){return console.error(t,n,r),!1})};e?this.te.transaction(i):this.te.readTransaction(i)},e.prototype.write=function(e,t,n,i,s){var a=this;if(!(t=t||o.generateID(this.Ye[e],this.ct[e].ai)))throw new Error("Can't add a row without a primary key!");var u=!1;if(-1===this.ct[e].indexOf(t)&&(u=!0,this.ct[e].add(t)),u){var c=r({},n,(h={},h[this.at[e]]=t,h));this.yt(!0,"INSERT into "+this.bt(e)+" (id, data) VALUES (?, ?)",[t,JSON.stringify(c)],function(e){i(c)})}else{var f=function(o){var s=r({},o,n,(u={},u[a.at[e]]=t,u));a.yt(!0,"UPDATE "+a.bt(e)+" SET data = ? WHERE id = ?",[JSON.stringify(s),t],function(){i(s)});var u};s?f({}):this.read(e,t,function(e){f(e)})}var h},e.prototype.delete=function(e,t,n){-1!==this.ct[e].indexOf(t)&&this.ct[e].remove(t),this.yt(!0,"DELETE FROM "+this.bt(e)+" WHERE id = ?",[t],function(){n()})},e.prototype.read=function(e,t,n){this.yt(!1,"SELECT data FROM "+this.bt(e)+" WHERE id = ?",[t],function(e){n(e.rows.length?JSON.parse(e.rows.item(0).data):void 0)})},e.prototype.rangeRead=function(e,t,n,r,o,s){var a=this,u=this.ct[e].keys(),c=-1===[typeof r,typeof o].indexOf("undefined"),f=c?[r,o]:[];if(!u.length)return void n();s&&c&&(f=f.map(function(t){return a.ct[e].getLocation(t)}));var h=f[0]||0,l=[],_=f[0],d="SELECT data from "+this.bt(e);if(f.length){for(var p="number"==typeof u[_];_<=f[1];)l.push(p?u[_]:'"'+u[_]+'"'),_++;d+=" WHERE id IN ("+l.join(", ")+")"}d+=" ORDER BY id",this.yt(!1,d,[],function(e){var r=0,o=function(){e.rows.length>r?t(JSON.parse(e.rows.item(r).data),h,function(){h++,r++,r>1e3?i.setFast(o):o()}):n()};o()})},e.prototype.drop=function(e,t){var n=new s.DatabaseIndex;n.doAI=this.ct[e].doAI,this.ct[e]=n,this.yt(!0,"DELETE FROM "+this.bt(e),[],function(e){t()})},e.prototype.getIndex=function(e,t,n){n(t?this.ct[e].keys().length:this.ct[e].keys())},e.prototype.destroy=function(e){var t=this;o.fastALL(Object.keys(this.ct),function(e,n,r){t.drop(e,r)}).then(e)},e}();t.me=a},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(3),o=n(0),s={select:function(e,t){e.vt(t)},upsert:function(e,t){e.gt(t)},delete:function(e,t){e.Ge(t)},drop:function(e,t){e.Ke(t)},"show tables":function(e,t){e.ne.result=Object.keys(e.se.tableInfo),t(e.ne)},describe:function(e,t){if("string"!=typeof e.ne.table)return void t(e.ne);e.ne.result=o.r(e.se.models[e.ne.table]),t(e.ne)}},a=function(){function e(e){this.se=e}return e.prototype.doQuery=function(e,t){this.ne=e,this.mt=Array.isArray(e.table),s[e.action](this,t)},e.prototype.wt=function(e){this.mt?new f(this.ne).getRows(e):new c(this.ne,this.se).getRows(function(t){e(t.filter(function(e){return e}))})},e.prototype.xt=function(e){var t=this;this.se.ye&&Object.keys(this.se.be[this.ne.table]).forEach(function(n){for(var r=e.length,i=!0;r--&&i;)t.se.be[t.ne.table][n][e[r]]&&(delete t.se.fe[t.ne.table][n],delete t.se.be[t.ne.table][n],i=!1)})},e.prototype.qt=function(e){var t=this;this.se.fe[this.ne.table][this.Ot]=e,this.se.be[this.ne.table][this.Ot]={},e.forEach(function(e){t.se.be[t.ne.table][t.Ot][e[t.se.tableInfo[t.ne.table].De]]=!0})},e.prototype.vt=function(e){var t=this;this.Ot=o.hash(JSON.stringify(r({},this.ne,{queryID:null})));var n=!this.ne.join&&!this.ne.orm&&this.se.ye&&!Array.isArray(this.ne.table);if(n&&this.se.fe[this.ne.table][this.Ot])return this.ne.result=this.se.fe[this.ne.table][this.Ot],void e(this.ne);this.wt(function(r){["having","orderBy","offset","limit","actionArgs","groupBy","orm","join"].filter(function(e){return t.ne[e]}).length?new u(t.ne,t.se).kt(r,function(i){n&&t.qt(r),t.ne.result=i,e(t.ne)}):(n&&t.qt(r),t.ne.result=r,e(t.ne))})},e.prototype.It=function(e,t,n,r,i){var s=this;this.se.tableInfo[e.Le].De,this.se.Ne(e.Le,t,function(t){o.fastALL(t,function(t,i,a){var u=Object.isFrozen(t)?o.r(t):t;if("array"===e.Me){u[e.Ce]=u[e.Ce]||[];var c=u[e.Ce].indexOf(r);n?-1===c?u[e.Ce].push(r):a():-1!==c?u[e.Ce].splice(c,1):a(),u[e.Ce].sort()}else u[e.Ce]=n?r:null;s.se.he.query("upsert",u).comment("ORM Update").manualExec({table:e.Le}).then(a)}).then(i)})},e.prototype.Et=function(e,t,n,r){var i=this;if(!this.se.je)return void r();var s=this.se.ke[this.ne.table];if(-1!==this.ne.comments.indexOf("ORM Update"))return void r();if(!s||!s.length)return void r();for(var a=Math.max(t.length,n.length),u=[];a--;)u.push(" ");o.fastCHAIN(u,function(r,a,u){o.fastALL(s,function(r,s,u){switch(e){case"del":var c=t[a][i.se.tableInfo[i.ne.table].De],f="array"===r.Se?t[a][r.Pe]||[]:[t[a][r.Pe]].filter(function(e){return e});i.It(r,f,!1,c,u);break;case"add":var h=n[a][i.se.tableInfo[i.ne.table].De];if(t[a])if(function(e,t){return Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.filter(function(e,n){return e!==t[n]}).length>0:e===t}(t[a][r.Pe],n[a][r.Pe]))u();else if("array"===r.Se){var l=(n[a][r.Pe]||[]).filter(function(e){return-1===(t[a][r.Pe]||[]).indexOf(e)}),_=(t[a][r.Pe]||[]).filter(function(e){return-1===(n[a][r.Pe]||[]).indexOf(e)});o.fastALL([l,_],function(e,t,n){i.It(r,e,0===t,h,n)}).then(u)}else{var d=function(){null!==n[a][r.Pe]&&void 0!==n[a][r.Pe]?i.It(r,[n[a][r.Pe]],!0,h,u):u()};null!==t[a][r.Pe]&&void 0!==t[a][r.Pe]?i.It(r,[t[a][r.Pe]],!1,h,d):d()}else{var p="array"===r.Se?n[a][r.Pe]||[]:[n[a][r.Pe]].filter(function(e){return e});p&&p.length?i.It(r,p,!0,h,u):u()}}}).then(u)}).then(r)},e.prototype.gt=function(e){var t=this,n=this.se.tableInfo[this.ne.table].De;if(this.mt)return void this.wt(function(n){t.ne.result=t.ne.table.map(function(e){return-1===n.indexOf(e)?e:r({},t.ne.actionArgs,e)}),e(t.ne)});if(this.ne.where)this.wt(function(r){r.length?o.fastCHAIN(r,function(e,r,i){t.se.ze(t.ne.table,e[n],e,t.ne.actionArgs||{},i)}).then(function(i){var o=i.map(function(e){return e[n]});t.xt(o),t.ne.result=[{msg:i.length+" row(s) modfied.",affectedRowPKS:o,affectedRows:i}],t.Et("add",r,i,function(){e(t.ne)})}):(t.ne.result=[{msg:"0 row(s) modfied.",affectedRowPKS:[],affectedRows:[]}],e(t.ne))});else{var i=this.ne.actionArgs||{};this.se.fe[this.ne.table]={};var s=function(r){t.se.ze(t.ne.table,i[n],r,i,function(i){t.ne.result=[{msg:"1 row inserted.",affectedRowPKS:[i[n]],affectedRows:[i]}],t.se.je?t.Et("add",[r].filter(function(e){return e}),[i],function(){e(t.ne)}):e(t.ne)})};void 0!==i[n]?this.se.Ne(this.ne.table,[i[n]],function(e){s(e.length?e[0]:null)}):s(null)}},e.prototype.Ge=function(e){var t=this;if(this.mt)return void(this.ne.where?this.wt(function(n){t.ne.result=t.ne.table.filter(function(e){return-1===n.indexOf(e)}),e(t.ne)}):(this.ne.result=[],e(this.ne)));this.ne.where?this.wt(function(n){n=n.filter(function(e){return e}),n.length?o.fastALL(n,function(e,n,r){t.se.Ge(t.ne.table,e[t.se.tableInfo[t.ne.table].De],r)}).then(function(r){t.se.fe[t.ne.table]={};var i=n.map(function(e){return e[t.se.tableInfo[t.ne.table].De]});t.xt(i),t.ne.result=[{msg:n.length+" row(s) deleted.",affectedRowPKS:i,affectedRows:n}],t.Et("del",n,[],function(){e(t.ne)})}):(t.ne.result=[{msg:"0 row(s) deleted.",affectedRowPKS:[],affectedRows:[]}],e(t.ne))}):this.Ke(e)},e.prototype.Ke=function(e){var t=this;if(this.mt)return this.ne.result=[],void e(this.ne);this.se.We(this.ne.table,void 0,void 0,function(n){t.se.fe[t.ne.table]={},t.se.be[t.ne.table]={},t.se.Ke(t.ne.table,function(){t.ne.result=[{msg:"'"+t.ne.table+"' table dropped.",affectedRowPKS:n.map(function(e){return e[t.se.tableInfo[t.ne.table].De]}),affectedRows:n}],t.Et("del",n,[],function(){e(t.ne)})})})},e}();t.ue=a;var u=function(){function e(e,t){this.q=e,this.s=t,this.At=[]}return e.prototype.St=function(e,t){var n=this;if(this.q.join){var r={};"cross"!==this.q.join.type&&this.q.join.where&&(r={jt:this.q.join.where[0],Rt:this.q.join.where[1],Tt:this.q.join.where[2]});var i=this.q.table,o=this.q.join.table;this.Pt(this.q.join.type,i,o,r,function(e){t(n.q.where?e.filter(function(e,t){return Array.isArray(n.q.where)?h(e,n.q.where||[],t,!0):n.q.where(e,t)}):n.q.range?e.filter(function(e,t){return n.q.range&&n.q.range[0]>=t&&n.q.range[1]<=t}):e)})}},e.prototype.Lt=function(e,t){return e.reduce(function(e,n){return-1!==n.indexOf(".length")?e+"."+String((t[n.replace(".length","")]||[]).length):e+"."+String(t[n])},"").slice(1)},e.prototype.Ct=function(e){var t=this,n=this.q.groupBy||{},r=e.sort(function(e,r){return t.Mt(e,r,n,!0)});return r.forEach(function(e,r){var i=Object.keys(n).map(function(t){return String(e[t])||""}).join(".");t.Nt||(t.Nt={}),t.Nt[i]||(t.Nt[i]=[]),t.Nt[i].push(r)}),r},e.prototype.Bt=function(e){var t=this;return e.filter(function(e,n){return Array.isArray(t.q.having)?h(e,t.q.having||[],n,!0):t.q.having(e,n)})},e.prototype.Dt=function(e){var t=this;return e.sort(function(e,n){return t.Mt(e,n,t.q.orderBy||{},!1)})},e.prototype.Kt=function(e){var t=this;return e.filter(function(e,n){return!t.q.offset||n>=t.q.offset})},e.prototype.Qt=function(e){var t=this;return e.filter(function(e,n){return!t.q.limit||n<t.q.limit})},e.prototype.Ht=function(e,t){var n=this,r=this.q.orm?this.q.orm.map(function(e){return"string"==typeof e?{key:e,limit:5}:e}):[];o.fastALL(e,function(e,t,s){e=Object.isFrozen(e)?o.r(e):e,o.fastALL(r,function(t,r,o){if(!e[t.key]||!e[t.key].length)return void o();var s=n.s.Ee[n.q.table][t.key];s?n.s.he.query("select").where([n.s.tableInfo[s.Ae].De,"array"===s.Se?"IN":"=",e[t.key]]).manualExec({table:s.Ae}).then(function(n){var r=i.nSQL().query("select",t.select);t.where&&r.where(t.where),void 0!==t.limit&&r.limit(t.limit),void 0!==t.offset&&r.offset(t.offset),t.orderBy&&r.orderBy(t.orderBy),r.manualExec({table:n}).then(function(r){n.filter(function(e){return e}).length?e[t.key]="array"===s.Se?r.reverse():r[0]:e[t.key]="array"===s.Se?[]:void 0,o()})}):o()}).then(function(){s(e)})}).then(t)},e.prototype.Pt=function(e,t,n,r,i){var o="right",s="outer",a=this,u=a.s.tableInfo[e===o?n:t],c=a.s.tableInfo[e===o?t:n],f=function(e,t){return[u,c].reduce(function(n,r,i){return r.$e.forEach(function(o){n[r.et+"."+o]=((0===i?e:t)||{})[o]}),n},{})},l=[],_=r&&r.Tt?r.Tt.split(".").pop()||"":"",d={},p=[];a.s.Ne(u.et,function(t,n,i){var y=!1;a.s.Ne(c.et,function(n,i,a){r&&"cross"!==e?h((b={},b[u.et]=t,b[c.et]=n,b),[r.jt,r.Rt,e===o?t[_]:n[_]],0)?(e===s&&(d[i]=!0),l.push(f(t,n)),y=!0):e===s&&(p[i]=n):(l.push(f(t,n)),y=!0),a(!1);var b},function(){!y&&["left",o,s].indexOf(e)>-1&&l.push(f(t,null)),i(!1)})},function(){if(e===s){for(var t=p.filter(function(e,t){return!d[t]}),n=0;n<t.length;)l.push(f(null,t[n])),n++;i(l)}else i(l)})},e.prototype.Mt=function(e,t,n,r){return Object.keys(n).reduce(function(i,s){var a=r?o.objQuery(s,e):e[s],u=r?o.objQuery(s,t):t[s];return i||(a===u?0:(a>u?1:-1)*("desc"===n[s]?-1:1))},0)},e.prototype.Ft=function(e,t){var n=this,r=this.q.actionArgs,s={},a={};if(r&&r.length){var u=!1,c={};r.forEach(function(e){if(-1!==e.indexOf("(")){var t=(e.match(/^.*\(/g)||[""])[0].replace(/\(|\)/g,"").toUpperCase(),n=i.NanoSQLInstance.functions[t],r=1===e.split(" AS ").length?t:(e.split(" AS ").pop()||"").trim();if(!n)throw new Error("'"+t+"' is not a valid function!");"A"===n.type&&(u=!0),c[e]={fn:n,key:r}}}),o.fastALL(r,function(t,r,i){if(t.indexOf("(")>-1){var f=(t.match(/\(.*\)/g)||[""])[0].replace(/\(|\)/g,"").split(",").map(function(e){return e.trim()});n.Nt&&u?o.fastALL(Object.keys(n.Nt),function(r,i,o){a[r]||(a[r]={}),(s=c[t].fn).call.apply(s,[e.filter(function(e,t){return n.Nt[r].indexOf(t)>-1}),function(e){a[r][c[t].key]=e,o()}].concat(f));var s}).then(i):(h=c[t].fn).call.apply(h,[e,function(e){s[c[t].key]=e,i()}].concat(f))}else i();var h}).then(function(){var i=function(e,t,i){var s={};return r.forEach(function(r){var a=r.indexOf("(")>-1,u=a?c[r].fn.type:"";if(r.indexOf(" AS ")>-1){var f=r.split(" AS "),h=a?c[r].key:f[0].trim();s[f[1]]=a?"A"===u?i[h]:i[h][t]:o.objQuery(h,e,void 0!==n.q.join)}else{var h=a?c[r].key:r;s[r]=a?"A"===u?i[h]:i[h][t]:o.objQuery(h,e,void 0!==n.q.join)}}),s};if(n.Nt&&u){var f=[];Object.keys(n.Nt).forEach(function(t){var r=e.filter(function(e,r){return n.Nt[t].indexOf(r)>-1}).filter(function(e,t){return t<1});r&&r.length&&f.push(i(r[0],0,a[t]))}),t(f)}else t(u?e.filter(function(e,t){return t<1}).map(function(e,t){return i(e,t,s)}):e.map(function(e,t){return i(e,t,s)}))})}else t(e)},e.prototype.kt=function(e,t){var n=this,r=function(){n.q.having&&(e=n.Bt(e)),n.q.orderBy&&(e=n.Dt(e)),n.q.offset&&(e=n.Kt(e)),n.q.limit&&(e=n.Qt(e)),t(e)},i=function(){n.q.actionArgs&&n.q.actionArgs.length?n.Ft(e,function(t){e=t,r()}):r()},o=function(){n.q.groupBy&&(e=n.Ct(e)),n.q.orm?n.Ht(e,function(t){e=t,i()}):i()};this.q.join?this.St(e,function(t){e=t,o()}):o()},e}();t.Wt=u;var c=function(){function e(e,t){this.q=e,this.s=t}return e.prototype.getRows=function(e){var t=this;if(this.q.join)return void e([]);if(this.q.join&&this.q.orm)throw new Error("Cannot do a JOIN and ORM command at the same time!");if([this.q.where,this.q.range,this.q.trie].filter(function(e){return e}).length>1)throw new Error("Can only have ONE of Trie, Range or Where!");return this.q.trie&&this.q.trie.column&&this.q.trie.search?void this.Jt(e):this.q.range&&this.q.range.length?void this.Vt(e):this.q.where&&this.q.where.length?Array.isArray(this.q.where)?("string"==typeof this.q.where[0]?0===this.Ut(this.q.where):0===(this.q.where||[]).reduce(function(e,n,r){return r%2==1?e:e+t.Ut(n)},0))?void this.zt(e):void this.Gt(e):void this.Gt(function(n){e(n.filter(t.q.where))}):void this.Gt(e)},e.prototype.zt=function(e){var t=this;if(this.q.where&&"string"==typeof this.q.where[0])this.Xt(this.q.where,e);else if(this.q.where){var n=[],r="";o.fastCHAIN(this.q.where,function(e,i,o){if("OR"===e||"AND"===e)return r=e,void o();t.Xt(e,function(e){if("AND"===r){var i=e.map(function(e){return e[t.s.tableInfo[t.q.table].De]});n=n.filter(function(e){return-1!==i.indexOf(e[t.s.tableInfo[t.q.table].De])})}else n.concat(e);o()})}).then(function(){e(n)})}},e.prototype.Xt=function(e,t){var n=this;if("BETWEEN"!==e[1]){var r=[];switch(e[1]){case"IN":r=e[2];break;case"=":r=[e[2]]}e[0]===this.s.tableInfo[this.q.table].De?this.s.Ne(this.q.table,r,t):o.fastALL(r,function(t,r,i){n.s.Fe(n.q.table,e[0],t,i)}).then(function(e){t([].concat.apply([],e))})}else{var i=e[0]===this.s.tableInfo[this.q.table].De?"":e[0];if(i){var s="_"+this.q.table+"_idx_"+i;this.s.Je(s,e[2][0],e[2][1],function(e){var r=[].concat.apply([],e);n.s.Ne(n.q.table,r,t)})}else this.s.Je(this.q.table,e[2][0],e[2][1],function(e){t(e)})}},e.prototype.Vt=function(e){var t=this;if(this.q.range){var n=this.q.range;this.s.ce.getIndex(this.q.table,!0,function(r){for(var i=n[0]>0?n[1]:r+n[0]-n[1],o=i,s=Math.abs(n[0])-1;s--;)o++;t.s.We(t.q.table,i,o,e)})}else e([])},e.prototype.Jt=function(e){this.q.trie?this.s.Ve(this.q.table,this.q.trie.column,this.q.trie.search,e):e([])},e.prototype.Gt=function(e){var t=this;this.s.Ne(this.q.table,function(e,n,r){r(!t.q.where||(Array.isArray(t.q.where)?h(e,t.q.where||[],n||0):t.q.where(e,n)))},e)},e.prototype.Ut=function(e){var t=this.s.tableInfo[this.q.table];return["=","IN","BETWEEN"].indexOf(e[1])>-1&&(e[0]===t.De||t.Be.indexOf(e[0])>-1)?0:1},e}();t.Yt=c;var f=function(){function e(e){this.q=e}return e.prototype.getRows=function(e){var t=this;if(this.q.join||this.q.orm||this.q.trie)throw new Error("Cannot do a JOIN, ORM or TRIE command with instance table!");if(this.q.range&&this.q.range.length){var n,r,i=this.q.range;n=i[0]<0?this.q.table.length+i[0]-i[1]:i[1];var o=Math.abs(i[0])-1;for(r=n;o--;)r++;return void e(this.q.table.filter(function(e,t){return t>=n&&t<=r}))}e(this.q.table.filter(function(e,n){return!t.q.where||(Array.isArray(t.q.where)?h(e,t.q.where||[],n):t.q.where(e,n))}))},e}();t.InstanceSelection=f;var h=function(e,t,n,r){var i=["AND","OR"];if("string"!=typeof t[0]){var s=!1,a=t.map(function(t,a){return-1!==i.indexOf(t)?("AND"===t&&(s=!0),t):0===l(t[2],t[1],"_IDX_"===t[0]?n:o.objQuery(t[0],e,r))});if(a.forEach(function(e,t){"OR"===e&&(a[t]=a[t-1]||a[t+1],a[t-1]=void 0,a[t+1]=void 0)}),a=a.filter(function(e){return void 0!==e}),s){var u,c=!1;return-1===a.reduce(function(e,t,n){return 0===n?(e.push(t),u=e.length-1,e):"AND"===t?(c=!0,e.push(t),e):c?(e.push(t),u=e.length-1,c=!1,e):(void 0!==u&&(e[u]=t||e[u]),e)},[]).filter(function(e){return void 0!==e}).indexOf(!1)}return-1!==a.indexOf(!0)}return 0===l(t[2],t[1],"_IDX_"===t[0]?n:o.objQuery(t[0],e,r))},l=function(e,t,n){var r=function(e){return["LIKE","NOT LIKE"].indexOf(t)>-1?String(e||"").toLowerCase():e},i=r(n),o=r(e);if("NULL"===e||"NOT NULL"===e){var s="="===t||"LIKE"===t;return("NULL"===e?null===n||void 0===n:null!==n&&void 0!==n)?s?0:1:s?1:0}switch(t){case"=":return i===o?0:1;case"!=":return i!==o?0:1;case">":return i>o?0:1;case"<":return i<o?0:1;case"<=":return i<=o?0:1;case">=":return i>=o?0:1;case"IN":return(o||[]).indexOf(i)<0?1:0;case"NOT IN":return(o||[]).indexOf(i)<0?0:1;case"REGEX":return i.match(o)?0:1;case"LIKE":return i.indexOf(o)<0?1:0;case"NOT LIKE":return i.indexOf(o)>0?1:0;case"BETWEEN":return o[0]<=i&&o[1]>=i?0:1;case"HAVE":return(i||[]).indexOf(o)<0?1:0;case"NOT HAVE":return(i||[]).indexOf(o)<0?0:1;case"INTERSECT":return(i||[]).filter(function(e){return(o||[]).indexOf(e)>-1}).length>0?0:1;case"NOT INTERSECT":return 0===(i||[]).filter(function(e){return(o||[]).indexOf(e)>-1}).length?0:1;default:return 1}}},function(e,t,n){var r=this&&this.T||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o=["_hist","_hist_ptr","_id"],s=function(){function e(e){this.historyModeArgs=e,this.$t={},this.Zt={},this.en={}}return e.prototype.willConnect=function(e,t){var n=this;this.parent=e.parent;var s={};Object.keys(e.models).forEach(function(t){if(0!==t.indexOf("_")){var r=i.r(e.models[t]).map(function(e){return e.props&&-1!==e.props.indexOf("pk")&&(n.$t[t]=e.key,n.Zt[t]=e.type,n.en[t]={}),delete e.props,delete e.default,e});r.unshift({key:"_id",type:"timeIdms",props:["pk"]}),s["_"+t+"__hist_rows"]=r,s["_"+t+"__hist_idx"]=[{key:"id",type:n.Zt[t],props:["pk"]},{key:"histRows",type:"timeIdms[]"},{key:"histPtr",type:"number"}]}});var a="string"!=typeof this.historyModeArgs,u=[{key:"id",type:"timeIdms",props:["pk"]},{key:"table",type:"string"},{key:"keys",type:"any[]"}],c=[{key:"id",type:"timeIdms",props:["pk"]},{key:"ptr",type:"int"}];"database"!==this.historyModeArgs&&this.historyModeArgs?("database"!==this.historyModeArgs||a)&&(this.historyModes={},a?this.historyModes=i.r(this.historyModeArgs):Object.keys(this.$t).forEach(function(e){n.historyModes[e]=n.historyModeArgs}),Object.keys(this.historyModes).forEach(function(e){"table"===n.historyModes[e]&&(s["_"+e+"__hist"]=u,s["_"+e+"__hist_ptr"]=c)})):(s[o[0]]=u,s[o[1]]=c),e.models=r({},e.models,s),t(e)},e.prototype.tn=function(e){return e?this.historyModes?"table"===this.historyModes[e]?"_"+e+"__hist":null:"_hist":"__null"},e.prototype.nn=function(e,t){var n=this,r=this.tn(e);r?this.parent.query("select").manualExec({table:r+"_ptr"}).then(function(o){o.length?t():n.parent.query("upsert",{id:i.timeid(!0),table:e,ptr:0}).manualExec({table:r+"_ptr"}).then(t)}):t()},e.prototype.didConnect=function(e,t){var n=this,r=function(){i.fastALL(Object.keys(n.en),function(e,t,r){n.parent.extend("idx","_"+e+"__hist_idx").then(function(t){t.forEach(function(t){n.en[e][t]=!0}),n.historyModes?n.nn(e,r):r()})}).then(t)};this.historyModes?r():this.parent.query("select").manualExec({table:"_hist_ptr"}).then(function(e){e.length?r():n.parent.query("upsert",{id:i.timeid(!0),table:"",ptr:0}).manualExec({table:"_hist_ptr"}).then(r)})},e.prototype.rn=function(e,t,n,r){var o=this,s="_"+e+"__hist_rows",a="_"+e+"__hist_idx";i.fastALL(t,function(t,n,u){o.parent.query("select").where(["id","=",t]).manualExec({table:a}).then(function(n){if(!n.length)return void u();var c=Object.isFrozen(n[0])?i.r(n[0]):n[0],f=[];if(r)f=f.concat(c.histRows.filter(function(e){return-1!==e})),c.histPtr=0,c.histRows=[];else{for(;c.histPtr--;)f.push(c.histRows.shift());c.histPtr=0}if(!f.length)return void u();o.parent.query("upsert",c).comment("History Purge").where(["id","=",t]).manualExec({table:a}).then(function(){o.parent.query("delete").comment("History Purge").where(["_id","IN",f]).manualExec({table:s}).then(function(){r?o.parent.query("select").where([o.$t[e],"=",t]).manualExec({table:e}).then(function(n){o.in(e,["change"],t,n[0],!1,u)}):u()})})})}).then(n)},e.prototype.sn=function(e,t,n){var r=this;this.parent.query("select").manualExec({table:e+"_ptr"}).then(function(o){var s=Object.isFrozen(o[0])?i.r(o[0]):o[0];if(n||s.ptr>0){var a=r.parent.query("select");n||a.range(-1*s.ptr,0),a.manualExec({table:e}).then(function(o){if(!o.length)return void t();var a={};o.forEach(function(e){a[e.table]||(a[e.table]=[]),a[e.table]=a[e.table].concat(e.keys)}),i.fastALL(Object.keys(a),function(e,t,i){r.rn(e,a[e],i,n)}).then(function(){r.parent.query("delete").comment("History Purge").where(["id","IN",o.map(function(e){return e.id})]).manualExec({table:e}).then(function(){s.ptr=0,r.parent.query("upsert",s).comment("History Purge").where(["id","=",s.id]).manualExec({table:e+"_ptr"}).then(t)})})})}else t()})},e.prototype.an=function(e,t,n){if(!this.historyModes)return void this.sn("_hist",n);var r=this.tn(e);r?this.sn(r,n):this.rn(e,t,n)},e.prototype.un=function(e,t,n){if(!this.historyModes)return void this.sn("_hist",n,!0);var r=this.tn(e);r?this.sn(r,n,!0):this.rn(e,[t],n,!0)},e.prototype.didExec=function(e,t){var n=this;e.table&&0!==e.table.indexOf("_")&&e.types.indexOf("change")>-1&&-1===e.query.comments.indexOf("History Write")?this.an(e.table,e.affectedRowPKS,function(){i.fastALL(e.affectedRows,function(t,r,i){var o=t[n.$t[e.table]];n.en[e.table][o]?n.in(e.table,e.types,o,t,!1,function(e){i(o)}):(n.en[e.table][o]=!0,n.in(e.table,e.types,o,t,!0,function(t){n.parent.query("upsert",{id:o,histRows:[t,-1],histPtr:0}).manualExec({table:"_"+e.table+"__hist_idx"}).then(function(){i(o)})}))}).then(function(r){n.cn(e,r,t)})}):t(e)},e.prototype.cn=function(e,t,n){var r=this.tn(e.table);r?this.parent.query("upsert",{id:i.timeid(!0),table:e.table,keys:t}).manualExec({table:r}).then(function(){n(e)}):n(e)},e.prototype.in=function(e,t,n,o,s,a){var u=this,c="_"+e+"__hist_idx",f=i.timeid(!0),h=function(e){u.parent.query("select").where(["id","=",n]).manualExec({table:c}).then(function(t){var r=Object.isFrozen(t[0])?i.r(t[0]):t[0];r.histRows.unshift(e),u.parent.query("upsert",r).where(["id","=",n]).manualExec({table:c}).then(function(){a(e)})})};t.indexOf("delete")>-1||t.indexOf("drop")>-1?h(-1):this.parent.query("upsert",r({_e:f},o)).manualExec({table:"_"+e+"__hist_rows"}).then(function(){if(s)return void a(f);h(f)})},e.prototype.extend=function(e,t,n){if("hist"===t[0]){var r=t[1],i=t[2],o=t[3];switch(r){case"<":case">":this.hn(r,i,o,function(n){e(t,[n])});break;case"?":this.ln(i,o,function(n){e(t,n)});break;case"rev":this._n(i,o,function(n){e(t,n)});break;case"clear":this.un(i,o,function(){e(t,n)})}}else e(t,n)},e.prototype._n=function(e,t,n){var r=this,s="_"+e+"__hist_idx";this.parent.query("select").where(["id","=",t]).manualExec({table:s}).then(function(t){var s=t[0].histRows.filter(function(e){return-1!==e});r.parent.query("select").where(["_id","IN",s]).manualExec({table:"_"+e+"__hist_rows"}).then(function(e){var r={};e.forEach(function(e){r[e[o[2]]]=Object.isFrozen(e)?i.r(e):e,delete r[e[o[2]]][o[2]]}),n([{pointer:t[0].histRows.length-t[0].histPtr-1,revisions:t[0].histRows.reverse().map(function(e){return-1===e?null:r[e]})}])})})},e.prototype.dn=function(e,t){var n=this;this.parent.extend("idx.length",e).then(function(r){n.parent.query("select").manualExec({table:e+"_ptr"}).then(function(e){if(!e.length)return void t([0,0]);t([r,r-e[0].ptr])})})},e.prototype.ln=function(e,t,n){if(!this.historyModes)return void this.dn("_hist",function(e){n(e)});var r=this.tn(e);if(r){if(!e)throw Error("Need a table to query this history!");this.dn(r,n)}else{if(!t)throw Error("Need a row primary key to query this history!");var i="_"+e+"__hist_idx";this.parent.query("select").where(["id","=",t]).manualExec({table:i}).then(function(e){var t=e[0];n([t.histRows.length,t.histRows.length-t.histPtr-1])})}},e.prototype.pn=function(e,t,n){var r=this;this.parent.query("select").manualExec({table:t+"_ptr"}).then(function(o){var s=i.r(o[0]);s.ptr+="<"===e?1:-1,s.ptr<0&&(s.ptr=0),r.parent.extend("idx.length",t).then(function(a){if(s.ptr>a&&(s.ptr=a),o[0].ptr===s.ptr)return void n(!1);r.parent.query("select").range(-1,"<"===e?o[0].ptr:s.ptr).manualExec({table:t}).then(function(o){r.parent.query("upsert",s).manualExec({table:t+"_ptr"}).then(function(){i.fastALL(o[0].keys,function(t,n,i){r.yn(e,o[0].table,t,i)}).then(function(e){n(e.indexOf(!0)>-1)})})})})})},e.prototype.yn=function(e,t,n,r){var o=this,s=function(e){o.parent.query("upsert",e).where([o.$t[t],"=",n]).manualExec({table:"_"+t+"__hist_idx"}).then(function(){r(!0)})};this.parent.query("select").where([this.$t[t],"=",n]).manualExec({table:"_"+t+"__hist_idx"}).then(function(a){var u=i.r(a[0]);if(u.histPtr+="<"===e?1:-1,u.histPtr<0&&(u.histPtr=0),u.histPtr>u.histRows.length-1&&(u.histPtr=u.histRows.length-1),u.histPtr===a[0].histPtr)return void r(!1);var c=u.histRows[u.histPtr];-1===c?o.parent.query("delete").comment("History Write").where([o.$t[t],"=",n]).manualExec({table:t}).then(function(){s(u)}):o.parent.query("select").where(["_id","=",c]).manualExec({table:"_"+t+"__hist_rows"}).then(function(e){o.parent.query("upsert",e[0]).comment("History Write").manualExec({table:t}).then(function(){s(u)})})})},e.prototype.hn=function(e,t,n,r){if(!this.historyModes)return void this.pn(e,"_hist",r);var i=this.tn(t);if(i){if(!t)throw Error("Need a table to change this history!");this.pn(e,i,r)}else{if(!n)throw Error("Need a row primary key to change this history!");this.yn(e,t,n,r)}},e}();t.z=s}])});